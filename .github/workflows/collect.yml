name: TUS Collector

on:
  schedule:
    - cron: "*/5 6-22 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Collect estimaciones
        run: PYTHONPATH=src python src/pulsetransit/collector.py estimaciones

      - name: Collect posiciones every 20 min
        run: |
          MINUTE=$(date -u +%M)
          if [ $((MINUTE % 20)) -eq 0 ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            PYTHONPATH=src python src/pulsetransit/collector.py posiciones
          else
            echo "Skipping posiciones this run (minute=$MINUTE)"
          fi

      - name: Validate
        run: PYTHONPATH=src python src/pulsetransit/validate.py

      - name: Commit DB update
        run: |
          git config user.name "tus-bot"
          git config user.email "bot@tus"
          git add -f data/tus.db
          git diff --cached --quiet || (
            git commit -m "data: collect $(date -u +%H:%M)" &&
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/pmatorras/pulsetransit.git
          )
